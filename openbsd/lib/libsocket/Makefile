ROOTDIR=../../..

include ${ROOTDIR}/Makefile.inc

RELEASE=75.0
LIBSOCKET= libsocket.so.${RELEASE}
IMPLIB= libsocket.dll.a
GCCDIR= ${GLIBDIR}/gcc/mingw32/${GCCVER}

all: objects lib

crt1.o: crt1.c
	${CC} -c ${CFLAGS} -I${ROOTDIR}/include $<

libsocket.a:
	@echo "Making static library $@"
	@ar cru $@ $(shell ls */*.o)

version.o: version.rc
	${XWINDRES} -DVERSION=\\\"${VERSION}\\\" -DRELEASE=\\\"${RELEASE}\\\" $< $@

${LIBSOCKET}: crt1.o version.o
	${LD} -s -shared ${LDFLAGS} -e _DllMainCRTStartup@12 --out-implib=${IMPLIB} \
	-o $@ crt1.o --image-base=${IMGBASE_LIBSOCKET} $(shell /bin/ls */*.so) version.o \
	-L${GLIBDIR} -L${GCCDIR} -lmingw32 -lmingwex -lmsvcrt -lgcc

%.d: %
	@${MAKE} -C $< XGCC="${XGCC}" ROOTDIR="${ROOTDIR}/.." SRCDIR="${SRCDIR}" \
	CFLAGS="${CFLAGS} -DLIBSOCK_IMPORT= -I${SRCDIR}/sys -I../../libc/include"

objects: asr.d net.d rpc.d

lib: ${LIBSOCKET} libsocket.a

lib-clean:
	/bin/rm -f *.o *.a ${LIBSOCKET}

objects-clean:
	/bin/rm -f */*.o */*.so

release-clean:
	/bin/rm version.o

# Perl needs libsocket.so

install-local:
	/bin/cp -vu ${IMPLIB} ${GLIBDIR}/
	/bin/cp -vu ${IMPLIB} ${GLIBDIR}/libsocket.so
	/bin/cp -vu libsocket.a ${GLIBDIR}/

install-cross:
	/bin/cp -vu libsocket.a ${XLIBDIR}/
	/bin/cp -vu ${IMPLIB} ${XLIBDIR}/libsocket.so

install: ${DESTDIR}
	${INSTALL} ${LIBSOCKET} libsocket.a ${DESTDIR}/usr/lib/
	@#${LN} -s ${LIBSOCKET} ${DESTDIR}/usr/lib/libsocket.so

clean: objects-clean lib-clean

